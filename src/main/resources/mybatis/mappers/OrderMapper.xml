<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.thoughtworks.ketsu.infrastructure.mybatis.mappers.OrderMapper">
    <insert id="createOrder" useGeneratedKeys="true" keyProperty="info.id" keyColumn="id">
        INSERT INTO orders (name, address, phone ,userid)
        VALUES (#{info.name}, #{info.address}, #{info.phone},#{userid} );
        SET @LAST_ORDER = LAST_INSERT_ID();
        INSERT INTO orderItems (orderid, productid, quantity, amount) VALUES
        <foreach collection="info.order_items" item="orderItem" open="(" separator="," close=")">
          @LAST_ORDER , #{orderItem.product_id} , #{orderItem.quantity} ,#{orderItem.quantity} * (
            SELECT price FROM products WHERE id = #{orderItem.product_id})
        </foreach>
    </insert>

    <select id="find_order_by_userid_and_orderid" resultMap="records.order">
        SELECT * FROM orders O , orderItems I WHERE O.id = #{id} AND I.orderid = #{id}
    </select>

    <select id="find_all_orders_by_userid" resultMap="records.order">
        SELECT * FROM orders O , orderItems I WHERE O.id = I.orderid
</select>

</mapper>
